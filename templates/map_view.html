<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NCM Satellite Explorer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- GLOBAL & LAYOUT --- */
        body { margin: 0; display: flex; font-family: 'Inter', sans-serif; background: #0f172a; color: white; height: 100vh; overflow: hidden; }
        
        /* --- SIDEBAR --- */
        .sidebar {
            width: 320px; 
            min-width: 320px; /* Prevent shrinking */
            background: rgba(18, 8, 34, 0.98); 
            padding: 20px;
            border-right: 1px solid rgba(255,255,255,0.1); 
            display: flex; 
            flex-direction: column;
            z-index: 1000; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            box-sizing: border-box; /* IMPORTANT: Keeps padding inside width */
        }
        
        .map-container { flex-grow: 1; position: relative; background: #000; }
        #map { width: 100%; height: 100%; }

        h1 { font-size: 1.2rem; margin-top: 0; color: #22d3ee; display: flex; align-items: center; gap: 10px; }
        label { display: block; margin-top: 15px; font-size: 0.85rem; color: #9ca3af; font-weight: 600; }
        
        select, input[type="date"] {
            width: 100%; padding: 10px; margin-top: 5px; background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 8px;
            box-sizing: border-box; /* Fixes width issues */
        }

        button { 
            width: 100%; padding: 12px; margin-top: 20px; 
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            border: none; border-radius: 8px; color: white;
            cursor: pointer; font-weight: bold; transition: 0.2s; 
        }
        button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); }
        button:disabled { opacity: 0.7; cursor: not-allowed; }

        /* --- STATS CARD --- */
        .stats-card {
            margin-top: 20px; padding: 15px; background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 10px;
            text-align: center;
        }

        /* --- TIMELINE FIX --- */
        .timeline-controls {
            margin-top: 20px; padding: 15px; 
            background: rgba(255,255,255,0.05); 
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        /* The Slider styling */
        input[type=range] { 
            width: 100%; /* Fits container */
            margin: 15px 0; 
            box-sizing: border-box;
            cursor: pointer;
        }
        
        .current-date { 
            text-align: center; color: #22d3ee; 
            font-weight: bold; font-size: 1.1rem; 
            margin-bottom: 5px;
        }

        /* --- LEGEND --- */
        .legend { margin-top: auto; padding-top: 20px; }
        .gradient-bar {
            height: 8px; width: 100%; border-radius: 4px;
            background: linear-gradient(to right, #ff4d4d, #f9cb28, #10b981); /* Red -> Yellow -> Green */
        }
        .legend-labels { display: flex; justify-content: space-between; font-size: 0.75rem; margin-top: 8px; color: #ccc; }

    </style>
</head>
<body>

    <div class="sidebar">
        <div>
            <h1>üõ∞Ô∏è Satellite Explorer</h1>
            <p style="font-size: 0.8rem; opacity: 0.7; margin-top: -5px;">Kingdom of Saudi Arabia Analysis</p>
        </div>

        <label>Index Formula</label>
        <select id="formula">
            <option value="ndvi">NDVI (Vegetation Health)</option>
            <option value="savi">SAVI (Soil Adjusted)</option>
            <option value="evi">EVI (Enhanced Index)</option>
        </select>

        <label>Simulation Dates</label>
        <div style="display: flex; gap: 8px;">
            <input type="date" id="date1" value="2024-01-15">
            <input type="date" id="date2" value="2024-06-15">
            <input type="date" id="date3" value="2024-12-15">
        </div>

        <button onclick="loadMapData()">Generate Satellite Analysis</button>

        <div id="stats-box" class="stats-card" style="display:none;">
            <div style="font-size: 0.75rem; color: #10b981; letter-spacing: 1px;">AVG INDEX VALUE</div>
            <div id="stats-val" style="font-size: 2.5rem; font-weight: 700; line-height: 1;">--</div>
        </div>

        <div class="timeline-controls" id="timeline" style="display:none;">
            <div class="current-date" id="display-date">Select Date</div>
            <input type="range" id="time-slider" min="0" max="2" value="0" step="1">
            <p style="font-size: 0.7rem; text-align: center; opacity: 0.5; margin: 0;">Slide to compare temporal changes</p>
        </div>

        <div class="legend">
            <div class="gradient-bar"></div>
            <div class="legend-labels">
                <span>Low (Soil/Sand)</span>
                <span>High (Healthy Veg)</span>
            </div>
        </div>
    </div>

    <div class="map-container">
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // --- 1. CONFIGURATION ---
        // Simplified Polygon for Saudi Arabia (KSA)
        // In production, load this from a detailed GeoJSON file.
        const ksaBorder = [
            [16.3, 42.0], [16.5, 43.0], [17.0, 44.5], [19.0, 45.0], [19.0, 48.0],
            [19.0, 50.0], [19.0, 52.0], [20.0, 55.0], [22.0, 55.0], [24.0, 52.0],
            [25.0, 50.5], [26.0, 50.0], [27.0, 49.0], [28.0, 48.5], [29.0, 48.0],
            [31.0, 47.0], [32.0, 40.0], [32.0, 39.0], [29.5, 35.0], [28.0, 34.5],
            [25.0, 37.0], [22.0, 39.0], [20.0, 40.0], [17.0, 41.5], [16.3, 42.0]
        ];

        // --- 2. INITIALIZE MAP ---
        const map = L.map('map', {
            zoomControl: false, // We will move this
            attributionControl: false
        }).setView([24.0, 45.0], 6); // Adjusted KSA Center

        L.control.zoom({ position: 'topright' }).addTo(map);

        // Dark Map Layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 18
        }).addTo(map);

        // --- 3. CREATE THE "COOKIE CUTTER" MASK ---
        // We create a polygon that covers the WHOLE WORLD, but has a "hole" in the shape of KSA.
        const worldCoords = [[90, -180], [90, 180], [-90, 180], [-90, -180]];
        
        // Leaflet supports holes by passing an array of arrays: [OuterPoly, InnerHole]
        const invertedMask = L.polygon([worldCoords, ksaBorder], {
            color: 'transparent',  // No border line
            fillColor: '#0f172a',  // Match the body background color (Dark Blue/Grey)
            fillOpacity: 1,      // 100% Opaque (Hides everything outside)
            interactive: false     // Click through to map
        }).addTo(map);

        // Add a faint border line for KSA just so we see the country shape clearly
        L.polyline(ksaBorder, {
            color: '#3b82f6', 
            weight: 2, 
            opacity: 0.5, 
            dashArray: '5, 5'
        }).addTo(map);


        // --- 4. APP LOGIC (Unchanged from before) ---
        let currentOverlays = [];
        let currentData = [];

        async function loadMapData() {
            const btn = document.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Simulating Satellite Pass...";
            btn.disabled = true;

            const dates = [
                document.getElementById('date1').value,
                document.getElementById('date2').value,
                document.getElementById('date3').value
            ];

            try {
                // Request data for the center of map (Simplified for POC)
                const center = map.getCenter();
                const response = await fetch('/get_map_layer', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        lat: center.lat,
                        lon: center.lng,
                        zoom: map.getZoom(),
                        dates: dates,
                        formula: document.getElementById('formula').value
                    })
                });

                const data = await response.json();
                currentData = data.layers;
                
                // Show Interface
                document.getElementById('timeline').style.display = 'block';
                document.getElementById('stats-box').style.display = 'block';
                
                const slider = document.getElementById('time-slider');
                slider.max = currentData.length - 1;
                slider.value = 0;
                
                updateLayer(0);

            } catch (err) {
                alert("Error connecting to Satellite backend.");
                console.error(err);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function updateLayer(index) {
            // Clear old layers
            currentOverlays.forEach(layer => map.removeLayer(layer));
            currentOverlays = [];

            const layerData = currentData[index];

            // Add Image Overlay BEHIND the mask
            // We use a large bounds to cover the "hole" we made
            const bounds = [[12, 30], [35, 60]]; 
            
            const overlay = L.imageOverlay(layerData.image, bounds, {
                opacity: 0.9,
                className: 'satellite-layer' // Class for custom CSS if needed
            });
            
            overlay.addTo(map);
            overlay.bringToBack(); // Push it behind the Mask/Labels
            
            currentOverlays.push(overlay);

            // Update UI
            document.getElementById('display-date').innerText = layerData.date;
            document.getElementById('stats-val').innerText = layerData.stats;
        }

        document.getElementById('time-slider').addEventListener('input', (e) => {
            updateLayer(e.target.value);
        });

    </script>
</body>
</html>
